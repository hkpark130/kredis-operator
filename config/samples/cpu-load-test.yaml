---
# CPU Load Test - 블랙프라이데이 읽기 부하 시뮬레이션
# 슬레이브 노드들에 직접 READONLY GET 요청 (고성능 버전)
apiVersion: v1
kind: ConfigMap
metadata:
  name: cpu-load-test-script
  namespace: kredis-operator-system
data:
  load-test.sh: |
    #!/bin/bash
    set -e
    
    SLAVE_HOST="kredis-sample-slave.kredis-operator-system.svc.cluster.local"
    MASTER_HOST="kredis-sample-master.kredis-operator-system.svc.cluster.local"
    PORT=6379
    
    echo "=== Black Friday Read Load Test ==="
    echo "Target: $SLAVE_HOST:$PORT"
    echo "Worker ID: $WORKER_ID"
    
    # 마스터에 테스트 키 생성
    echo "Setting test key on master..."
    redis-cli -h $MASTER_HOST -p $PORT -c SET loadtest "blackfriday" > /dev/null 2>&1 || true
    sleep 2
    
    echo "Starting high-performance READONLY GET load..."
    
    # 고성능 워커 함수 - 각각 별도 프로세스로 실행
    worker() {
      while true; do
        # yes 명령으로 빠르게 GET 명령 생성 (쉘 루프보다 100배 빠름)
        # head로 10만개로 제한, 파이프라인으로 전송
        {
          echo "READONLY"
          yes "GET loadtest" | head -n 100000
        } | redis-cli -h $SLAVE_HOST -p $PORT > /dev/null 2>&1
      done
    }
    
    # 10개의 병렬 워커 실행 (각 Pod당)
    echo "Starting 10 parallel workers..."
    for i in $(seq 1 10); do
      worker &
    done
    
    # 워커들이 끝날 때까지 대기
    wait
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cpu-load-test
  namespace: kredis-operator-system
  labels:
    app: cpu-load-test
spec:
  replicas: 5
  selector:
    matchLabels:
      app: cpu-load-test
  template:
    metadata:
      labels:
        app: cpu-load-test
    spec:
      containers:
      - name: load-generator
        image: redis:7.0
        command: ["/bin/bash", "/scripts/load-test.sh"]
        env:
        - name: WORKER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        - name: script
          mountPath: /scripts
        resources:
          requests:
            cpu: "200m"
            memory: "128Mi"
          limits:
            cpu: "1000m"
            memory: "256Mi"
      volumes:
      - name: script
        configMap:
          name: cpu-load-test-script
          defaultMode: 0755
      restartPolicy: Always
