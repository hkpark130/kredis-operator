---
# Memory Load Test - 대량의 데이터를 삽입하여 Memory 부하 생성
# 사용법: kubectl apply -f config/samples/load-test-job.yaml
# 삭제: kubectl delete -f config/samples/load-test-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-memory-load-test
  namespace: kredis-operator-system
spec:
  template:
    spec:
      containers:
      - name: load-test
        image: redis:7.0
        command:
        - /bin/bash
        - -c
        - |
          echo "Starting memory load test..."
          # 헤드리스 서비스 사용 (외부 서비스에서 접근하는 것과 동일한 방식)
          REDIS_HOST="kredis-sample-master.kredis-operator-system.svc.cluster.local"
          
          # 먼저 연결 테스트
          echo "Testing connection..."
          redis-cli -c -h $REDIS_HOST -p 6379 PING
          if [ $? -ne 0 ]; then
            echo "Failed to connect to Redis!"
            exit 1
          fi
          
          echo "Cluster info:"
          redis-cli -c -h $REDIS_HOST -p 6379 CLUSTER INFO | head -5
          
          # 10KB 크기의 값을 50000개 삽입 (약 500MB, 클러스터에 분산됨)
          # maxmemory 700Mi의 20% = 140MB per node, 3 masters = 420MB 필요
          VALUE_SIZE=10240  # 10KB
          echo "Generating ${VALUE_SIZE} byte value..."
          VALUE=$(head -c $VALUE_SIZE /dev/urandom | base64 | head -c $VALUE_SIZE)
          
          echo "Starting data insertion..."
          for i in $(seq 1 50000); do
            RESULT=$(redis-cli -c -h $REDIS_HOST -p 6379 SET "loadtest:key:$i" "$VALUE" 2>&1)
            if [ "$RESULT" != "OK" ]; then
              echo "Error on key $i: $RESULT"
            fi
            if [ $((i % 1000)) -eq 0 ]; then
              echo "Inserted $i keys..."
              redis-cli -c -h $REDIS_HOST -p 6379 INFO memory | grep used_memory_human
              redis-cli -c -h $REDIS_HOST -p 6379 DBSIZE
            fi
          done
          
          echo "Memory load test completed!"
          echo "Final memory usage:"
          redis-cli -c -h $REDIS_HOST -p 6379 INFO memory | grep used_memory
          echo "Total keys:"
          redis-cli -c -h $REDIS_HOST -p 6379 DBSIZE
          
          echo "Data will be kept for 10 minutes..."
          sleep 600
      restartPolicy: Never
  backoffLimit: 1
---
# CPU Load Test - 대량의 GET/SET 요청으로 CPU 부하 생성
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-cpu-load-test
  namespace: kredis-operator-system
spec:
  parallelism: 3  # 3개의 파드가 동시에 부하 생성
  template:
    spec:
      containers:
      - name: load-test
        image: redis:7.0
        command:
        - /bin/bash
        - -c
        - |
          echo "Starting CPU load test with redis-benchmark..."
          # 헤드리스 서비스 사용 (외부 서비스에서 접근하는 것과 동일한 방식)
          REDIS_HOST="kredis-sample-master.kredis-operator-system.svc.cluster.local"
          
          # 먼저 클러스터 정보 확인
          echo "Cluster nodes:"
          redis-cli -c -h $REDIS_HOST -p 6379 CLUSTER NODES | head -5
          
          # 100개 연결, 50만 요청 (클러스터 모드)
          redis-benchmark -h $REDIS_HOST -p 6379 \
            -c 100 -n 500000 \
            -t get,set \
            -d 256 \
            --cluster
          
          echo "CPU load test completed"
      restartPolicy: Never
  backoffLimit: 1

